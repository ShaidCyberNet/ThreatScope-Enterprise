<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreatScope Enterprise - SOC Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            overflow-x: auto;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-item {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .status-active { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-critical { background-color: #e74c3c; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background-color: #2c3e50;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #34495e;
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }
        
        .metrics-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        
        .metric-value {
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        .severity-critical { color: #e74c3c; }
        .severity-high { color: #f39c12; }
        .severity-medium { color: #f1c40f; }
        .severity-low { color: #27ae60; }
        
        .events-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .event-item {
            background-color: #34495e;
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .event-critical { border-left-color: #e74c3c; }
        .event-high { border-left-color: #f39c12; }
        .event-medium { border-left-color: #f1c40f; }
        .event-low { border-left-color: #27ae60; }
        
        .event-ip {
            font-family: monospace;
            background-color: #1a1a1a;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .refresh-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            margin-top: -0.5rem;
        }
        
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
        }
        .new-threat {
					 animation HighlightFade 3s ease-out
		}
		
		@keyframes HighlightFade {
				0%{background-color:  #3498db;}
				100%{background-color: #34495e;}
				
		}
		
		.threat-notification {
								postition: fixed;
								top: 20px;
								right: 10px;
								padding: 1rem;
								border-radius: 5px;
								color: white;
								font-weight: bold;
								z-index: 1000;
								animation: slideIn 0.3s ease-out;
							}
							
		.threat-notification.severity-critical {
					background-color: red;
		}
		
		.threat-notification.severity-high {
			background-color: orange;
		}
		
		.threat-notification.severity-medium {
			background-color: yellow;
		}
		.threat-notification.severity-low {
			background-color: green;
		}
		
		@keyframes slideIn {
			from {transform: translateX(100%); }
			to {transform: translateX(0); }
			
		}
		
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ThreatScope Enterprise</div>
        <div class="status">
            <div class="status-item status-active">Monitoring: ACTIVE</div>
            <div class="status-item" id="threat-level">Threat Level: LOW</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Threat Metrics Card -->
        <div class="card">
            <h3>24-Hour Threat Metrics</h3>
            <button class="refresh-btn" onclick="loadDashboardData()">Refresh</button>
            
            <div class="metrics-row">
                <span>Total Events:</span>
                <span class="metric-value" id="total-events">-</span>
            </div>
            <div class="metrics-row">
                <span>Critical:</span>
                <span class="metric-value severity-critical" id="critical-events">-</span>
            </div>
            <div class="metrics-row">
                <span>High:</span>
                <span class="metric-value severity-high" id="high-events">-</span>
            </div>
            <div class="metrics-row">
                <span>Medium:</span>
                <span class="metric-value severity-medium" id="medium-events">-</span>
            </div>
            <div class="metrics-row">
                <span>Blocked IPs:</span>
                <span class="metric-value" id="blocked-ips">-</span>
            </div>
        </div>

        <!-- Recent Threats Card -->
        <div class="card">
            <h3>Recent Threats</h3>
            <div class="events-list" id="recent-events">
                <div>Loading...</div>
            </div>
        </div>

        <!-- Response Actions Card -->
        <div class="card">
            <h3>Automated Response Log</h3>
            <div class="events-list" id="response-log">
                <div>Loading...</div>
            </div>
        </div>
    </div>

    <script>
    // WebSocket connection for real-time updates
    let ws = null;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/dashboard`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            updateConnectionStatus(true);
        };
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleRealtimeUpdate(data);
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        ws.onclose = function() {
            console.log('WebSocket disconnected');
            updateConnectionStatus(false);
            
            // Attempt to reconnect
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, 2000 * reconnectAttempts);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateConnectionStatus(false);
        };
    }
    
    function handleRealtimeUpdate(data) {
        if (data.type === 'new_threat') {
            // Add new threat to the top of the list
            addNewThreatToList(data.event);
            
            // Update metrics if provided
            if (data.stats) {
                updateRealtimeStats(data.stats);
            }
            
            // Flash notification
            showThreatNotification(data.event);
        }
    }
    
    function addNewThreatToList(event) {
        const container = document.getElementById('recent-events');
        
        // Create new event element
        const eventElement = document.createElement('div');
        eventElement.className = `event-item event-${event.severity} new-threat`;
        eventElement.innerHTML = `
            <div>
                <span class="event-ip">${event.ip_address}</span>
                <strong>${event.severity.toUpperCase()}</strong> - Score: ${event.score}
            </div>
            <div style="font-size: 0.9em; margin-top: 0.5rem;">
                ${event.threat_type} | ${event.country || 'Unknown'}
            </div>
            <div style="font-size: 0.8em; color: #bdc3c7; margin-top: 0.3rem;">
                ${new Date(event.created_at).toLocaleString()}
            </div>
        `;
        
        // Add to top of list
        container.insertBefore(eventElement, container.firstChild);
        
        // Remove highlight after 3 seconds
        setTimeout(() => {
            eventElement.classList.remove('new-threat');
        }, 3000);
        
        // Keep only last 10 events
        while (container.children.length > 10) {
            container.removeChild(container.lastChild);
        }
    }
    
    function showThreatNotification(event) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `threat-notification severity-${event.severity}`;
        notification.innerHTML = `
            <strong>New ${event.severity.toUpperCase()} Threat!</strong><br>
            ${event.ip_address} - ${event.threat_type}
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 5000);
    }
    
    function updateConnectionStatus(connected) {
        const status = document.querySelector('.status');
        const monitoringStatus = status.querySelector('.status-active');
        
        if (connected) {
            monitoringStatus.textContent = 'Monitoring: LIVE';
            monitoringStatus.className = 'status-item status-active';
        } else {
            monitoringStatus.textContent = 'Monitoring: RECONNECTING';
            monitoringStatus.className = 'status-item status-warning';
        }
    }
    
    function updateRealtimeStats(stats) {
        if (stats.blocked_ips !== undefined) {
            document.getElementById('blocked-ips').textContent = stats.blocked_ips;
        }
    }
    
    // Load initial dashboard data (existing function)
    async function loadDashboardData() {
        try {
            const postureResponse = await fetch('/api/stats/security-posture');
            const posture = await postureResponse.json();
            
            const eventsResponse = await fetch('/api/events/recent?limit=10');
            const events = await eventsResponse.json();
            
            const responseResponse = await fetch('/api/response/log?limit=10');
            const responseLog = await responseResponse.json();
            
            updateMetrics(posture);
            updateRecentEvents(events);
            updateResponseLog(responseLog.response_log || []);
            updateThreatLevel(posture);
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }
    
    // (Keep your existing updateMetrics, updateRecentEvents, etc. functions here)
    function updateMetrics(posture) {
        document.getElementById('total-events').textContent = posture.total_events_24h || 0;
        document.getElementById('critical-events').textContent = posture.critical_events_24h || 0;
        document.getElementById('high-events').textContent = posture.high_events_24h || 0;
        document.getElementById('medium-events').textContent = posture.medium_events_24h || 0;
        document.getElementById('blocked-ips').textContent = posture.blocked_ips_count || 0;
    }
    
    function updateRecentEvents(events) {
        const container = document.getElementById('recent-events');
        
        if (!events || events.length === 0) {
            container.innerHTML = '<div>No recent threats detected</div>';
            return;
        }
        
        container.innerHTML = events.map(event => `
            <div class="event-item event-${event.severity}">
                <div>
                    <span class="event-ip">${event.ip_address}</span>
                    <strong>${event.severity.toUpperCase()}</strong> - Score: ${event.score}
                </div>
                <div style="font-size: 0.9em; margin-top: 0.5rem;">
                    ${event.threat_type} | ${event.country || 'Unknown'}
                </div>
                <div style="font-size: 0.8em; color: #bdc3c7; margin-top: 0.3rem;">
                    ${new Date(event.created_at).toLocaleString()}
                </div>
            </div>
        `).join('');
    }
    
    function updateResponseLog(responseLog) {
        const container = document.getElementById('response-log');
        
        if (!responseLog || responseLog.length === 0) {
            container.innerHTML = '<div>No automated responses taken</div>';
            return;
        }
        
        container.innerHTML = responseLog.map(log => `
            <div class="event-item">
                <div>
                    <span class="event-ip">${log.ip_address}</span>
                    <strong>${log.severity.toUpperCase()}</strong>
                </div>
                <div style="font-size: 0.9em; margin-top: 0.5rem;">
                    Actions: ${Object.keys(log.actions).join(', ')}
                </div>
                <div style="font-size: 0.8em; color: #bdc3c7; margin-top: 0.3rem;">
                    ${new Date(log.timestamp).toLocaleString()}
                </div>
            </div>
        `).join('');
    }
    
    function updateThreatLevel(posture) {
        const threatLevel = document.getElementById('threat-level');
        const critical = posture.critical_events_24h || 0;
        const high = posture.high_events_24h || 0;
        
        if (critical > 0) {
            threatLevel.textContent = 'Threat Level: CRITICAL';
            threatLevel.className = 'status-item status-critical';
        } else if (high > 5) {
            threatLevel.textContent = 'Threat Level: HIGH';
            threatLevel.className = 'status-item status-warning';
        } else {
            threatLevel.textContent = 'Threat Level: LOW';
            threatLevel.className = 'status-item status-active';
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        connectWebSocket();
        
        // Still refresh periodically as backup
        setInterval(loadDashboardData, 60000); // Every minute instead of 30 seconds
    });
    </script>
</body>
</html>
